<!DOCTYPE html>
<html>
<head>
    <title>Employee Management (API)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-dark text-white">
<div class="container mt-5">
    <h2 class="text-center mb-4">Employee Management (API View)</h2>

    <!-- Add/Edit Employee Form -->
    <div class="card bg-secondary p-3 mb-4">
        <h5 id="formTitle">Add Employee</h5>
        <div class="row g-2">
            <div class="col-md-3"><input id="name" class="form-control" placeholder="Name"></div>
            <div class="col-md-3"><input id="position" class="form-control" placeholder="Position"></div>
            <div class="col-md-3"><input id="salary" class="form-control" placeholder="Salary" type="number"></div>
            <div class="col-md-3">
                <input id="image" class="form-control" type="file">
            </div>
        </div>
        <button id="submitBtn" onclick="addOrUpdateEmployee()" class="btn btn-success mt-3 w-100">Add Employee</button>
    </div>

    <!-- Employee List Table -->
    <table class="table table-bordered table-striped table-dark">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Position</th>
                <th>Salary</th>
                <th>Image</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="employeeTable"></tbody>
    </table>
</div>

<script>
const baseURL = '/apiapp/employees/';
let editId = null;  // 🧠 To know whether we're editing or adding

// ✅ Load all employees
function loadEmployees() {
    fetch(baseURL)
        .then(res => res.json())
        .then(data => {
            const table = document.getElementById('employeeTable');
            table.innerHTML = '';
            data.forEach(emp => {
                table.innerHTML += `
                    <tr>
                        <td>${emp.id}</td>
                        <td>${emp.name}</td>
                        <td>${emp.position}</td>
                        <td>${emp.salary}</td>
                        <td>${emp.image ? `<img src="${emp.image}" width="60">` : 'No image'}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editEmployee(${emp.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEmployee(${emp.id})">Delete</button>
                        </td>
                    </tr>
                `;
            });
        });
}

// ✅ Add or Update Employee
function addOrUpdateEmployee() {
    const formData = new FormData();
    formData.append('name', document.getElementById('name').value);
    formData.append('position', document.getElementById('position').value);
    formData.append('salary', document.getElementById('salary').value);
    const imageFile = document.getElementById('image').files[0];
    if (imageFile) formData.append('image', imageFile);

    let url = baseURL;
    let method = 'POST';
    let successMsg = 'Employee added!';

    // 🔁 If editing
    if (editId) {
        url = baseURL + editId + '/';
        method = 'PUT';
        successMsg = 'Employee updated!';
    }

    fetch(url, { method: method, body: formData })
    .then(res => res.json())
    .then(data => {
        alert(successMsg);
        resetForm();
        loadEmployees();
    });
}

// 🟡 Reset form after add/update
function resetForm() {
    document.getElementById('name').value = '';
    document.getElementById('position').value = '';
    document.getElementById('salary').value = '';
    document.getElementById('image').value = '';
    document.getElementById('formTitle').innerText = 'Add Employee';
    document.getElementById('submitBtn').innerText = 'Add Employee';
    document.getElementById('submitBtn').classList.replace('btn-warning', 'btn-success');
    editId = null;
}

// ✅ Delete Employee
function deleteEmployee(id) {
    if (confirm('Are you sure you want to delete this employee?')) {
        fetch(baseURL + id + '/', { method: 'DELETE' })
        .then(res => {
            if (res.status === 204) {
                alert('Deleted successfully!');
                loadEmployees();
            } else {
                alert('Failed to delete');
            }
        });
    }
}

// ✅ Edit Employee — fills form instead of prompt
function editEmployee(id) {
    fetch(baseURL + id + '/')
    .then(res => res.json())
    .then(emp => {
        document.getElementById('name').value = emp.name;
        document.getElementById('position').value = emp.position;
        document.getElementById('salary').value = emp.salary;
        document.getElementById('image').value = '';  // can’t prefill file input
        editId = id;  // mark which employee we’re editing
        document.getElementById('formTitle').innerText = 'Edit Employee';
        document.getElementById('submitBtn').innerText = 'Update Employee';
        document.getElementById('submitBtn').classList.replace('btn-success', 'btn-warning');
    });
}

// Load employees when page opens
loadEmployees();
</script>

</body>
</html>
